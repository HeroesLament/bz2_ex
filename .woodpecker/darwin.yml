when:
  - event: tag
  - event: manual

steps:
  - name: build-darwin
    image: docker:cli
    volumes:
      - /run/podman/podman.sock:/var/run/docker.sock
    commands:
      - |
        cat > /tmp/Dockerfile.darwin << 'EOF'
        FROM crazymax/osxcross:latest AS osxcross
        FROM rust:latest AS builder
        RUN apt-get update && apt-get install -y clang lld
        COPY --from=osxcross /osxcross /osxcross
        ENV PATH="/osxcross/bin:$PATH"
        ENV LD_LIBRARY_PATH="/osxcross/lib:$LD_LIBRARY_PATH"
        WORKDIR /build
        COPY native/bz2_ex /build/native/bz2_ex
        RUN rustup target add x86_64-apple-darwin aarch64-apple-darwin
        RUN cd native/bz2_ex && \
            CC=o64-clang CXX=o64-clang++ \
            CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER=o64-clang \
            RUSTLER_NIF_VERSION=2.16 \
            cargo build --release --target x86_64-apple-darwin
        RUN cd native/bz2_ex && \
            CC=oa64-clang CXX=oa64-clang++ \
            CARGO_TARGET_AARCH64_APPLE_DARWIN_LINKER=oa64-clang \
            RUSTLER_NIF_VERSION=2.16 \
            cargo build --release --target aarch64-apple-darwin
        FROM scratch AS export
        COPY --from=builder /build/native/bz2_ex/target/x86_64-apple-darwin/release/libbz2_ex.dylib /x86_64-apple-darwin/
        COPY --from=builder /build/native/bz2_ex/target/aarch64-apple-darwin/release/libbz2_ex.dylib /aarch64-apple-darwin/
        EOF
      - docker build -f /tmp/Dockerfile.darwin -o artifacts/darwin .